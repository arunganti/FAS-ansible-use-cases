- name: Creating HTTP-Redirect for Existing Application
  hosts: lb 
  connection: local
  gather_facts: false
  
#Environment variables defined
  environment:
    F5_USER: "{{ ansible_user }}"
    F5_PASSWORD: "{{ ansible_ssh_pass }}"
    F5_SERVER_PORT: "{{ F5_Admin_Port }}" 
    F5_VALIDATE_CERTS: "False"
    F5_SERVER: "{{ private_ip }}"
    
  tasks:
#Creeate VIP and Pool Member for Use Case
  - name: Create Pool with Members
    bigip_pool:
      state: present
      name: "{{ F5_VIP_Name }}_pool"
      lb_method: round-robin
      monitors:
        - http

  - name: Add Pool Members
    bigip_pool_member:
      state: present
      pool: "{{ F5_VIP_Name }}_pool"
      name: "{{hostvars[item].inventory_hostname}}"
      host: "{{hostvars[item].private_ip}}"
      port: "80"
    loop: "{{ groups['webservers'] }}"

  - name: Create a HTTPS Virtual Server
    bigip_virtual_server:
      state: present
      description: "Https Virtual Server"
      name: "{{ F5_VIP_Name }}_https_vip"
      destination: "{{ private_ip }}"
      port: "443"
      pool: "{{ F5_VIP_Name }}_pool"
      snat: Automap
      profiles:
       - http
       - name: clientssl
         context: client-side
       - oneconnect
    when: F5_VIP_Name is defined

#Create HTTP Redirect VS
  - name: Create a HTTP Redirect Virtual Server
    bigip_virtual_server:
      description: "Redirect Virtual server"
      name: "{{ F5_VIP_Name }}_http_redirect"
      destination: "{{ private_ip }}"
      port: "80"
      all_profiles:
       - http
      all_rules:
       - _sys_https_redirect
